using Blip.Dealer.Desk.Manager.Facades;
using Blip.Dealer.Desk.Manager.Facades.Interfaces;
using Blip.Dealer.Desk.Manager.Models.Request;
using Microsoft.AspNetCore.Mvc;

namespace Blip.Dealer.Desk.Manager.Controllers;

[ApiController]
[Route("api/[controller]")]
public class InitialSetupController(IDealerSetupFacade deskManagerFacade,
                                    IServiceHourFacade serviceHourFacade,
                                    ITagsFacade tagsFacade,
                                    ICustomRepliesFacade customRepliesFacade,
                                    IAttendantsFacade attendantsFacade,
                                    IFlowFacade flowFacade) : ControllerBase
{

    [HttpPost("dealers")]
    public async Task<IActionResult> PublishDealerSetupAsync([FromHeader] string token,
                                                             [FromBody] PublishDealerSetupRequest request)
    {
        request.SetBearerToken(token);

        await deskManagerFacade.PublishDealerSetupAsync(request);

        return Ok();
    }

    [HttpPost("service-hours")]
    public async Task<IActionResult> PublishDealerServiceHoursAsync([FromHeader] string token,
                                                                    [FromBody] PublishServiceHoursRequest request)
    {
        request.SetBearerToken(token);

        await serviceHourFacade.PublishDealersServiceHoursAsync(request);

        return Ok();
    }

    [HttpPost("tags")]
    public async Task<IActionResult> PublishTagsAsync([FromHeader] string token,
                                                      [FromBody] PublishTagsRequest request)
    {
        request.SetBearerToken(token);

        await tagsFacade.PublishTagsAsync(request);

        return Ok();
    }

    [HttpPost("custom-reply")]
    public async Task<IActionResult> PublishCustomRepliesAsync([FromHeader] string token,
                                                               [FromBody] PublishCustomRepliesRequest request)
    {
        request.SetBearerToken(token);

        await customRepliesFacade.PublishCustomRepliesAsync(request);

        return Ok();
    }

    [HttpPost("attendants")]
    public async Task<IActionResult> PublishAttendantsAsync([FromHeader] string token,
                                                            [FromBody] PublishAttendantsRequest request)
    {
        request.SetBearerToken(token);

        await attendantsFacade.PublishAttendantsAsync(request);

        return Ok();
    }

    [HttpPost("flow")]
    public async Task<IActionResult> PublishFlowAsync([FromHeader] string token,
                                                      [FromHeader] string spreadSheetId,
                                                      [FromHeader] string sheetName,
                                                      [FromHeader] string brand,
                                                      [FromHeader] string tenantId,
                                                      IFormFile flow)
    {
        var request = new PublishFlowRequest() 
        {
            Brand = brand,
            Tenant = tenantId,
            DataSource = new GoogleSheetsRequest() 
            {
                SpreadSheetId = spreadSheetId,
                Name = sheetName
            },
            FlowStr = "{\"identifier\":\"<SHORTNAME>\",\"messageReceivers\":[{\"state\":\"default\",\"type\":\"MessageReceiver\"}],\"notificationReceivers\":[{\"type\":\"DeskNotificationReceiver\"}],\"serviceProviderType\":\"ServiceProvider\",\"settings\":{\"flow\":{\"id\":\"2d372d8f-921d-4e4f-a646-4e14014b5f5b\",\"version\":1,\"states\":[{\"id\":\"onboarding\",\"root\":true,\"name\":\"Start\",\"inputActions\":[],\"input\":{\"bypass\":false},\"outputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"stateId\":\"onboarding\",\"stateName\":\"Start\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"onboarding\",\"#stateName\":\"Start\",\"#stateId\":\"onboarding\",\"#messageId\":\"{{input.message@id}}\"},\"category\":\"flow\",\"action\":\"Start\"}}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5c991c70-2844-4d70-b9a8-60fa9245d982\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"matches\",\"values\":[\".*\"]}]},{\"stateId\":\"fallback\"}]},{\"id\":\"fallback\",\"name\":\"Exceptions\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"fallback\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Exceptions\"}}],\"input\":{\"bypass\":true},\"outputActions\":[],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"error\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"matches\",\"values\":[\".*\"]}]},{\"stateId\":\"onboarding\"}]},{\"id\":\"error\",\"name\":\"Default error\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"error\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Default error\"}}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"dealerDeskOrigin\",\"value\":\"Default error\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"typeOfStateId\":\"state\"}]},{\"id\":\"desk:668c6deb-1a44-43b4-ba93-9f2ec93e0e4d\",\"root\":false,\"name\":\"Customer service\",\"deskStateVersion\":\"3.0.0\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"desk:668c6deb-1a44-43b4-ba93-9f2ec93e0e4d\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Customer service\"}},{\"type\":\"ForwardToDesk\",\"conditions\":[],\"settings\":{}}],\"input\":{\"bypass\":false,\"conditions\":[{\"source\":\"context\",\"variable\":\"desk_forwardToDeskState_status\",\"comparison\":\"equals\",\"values\":[\"Success\"]}]},\"outputActions\":[],\"afterStateChangedActions\":[{\"type\":\"LeavingFromDesk\",\"conditions\":[],\"settings\":{}}],\"outputs\":[{\"conditions\":[{\"source\":\"context\",\"variable\":\"desk_forwardToDeskState_status\",\"comparison\":\"equals\",\"values\":[\"NoAgentAvailable\"]}],\"stateId\":\"c0eaa7f1-01e2-4436-9c9d-0e04f14d2d9e\"},{\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedAttendant\"]}],\"stateId\":\"c6851223-c62f-4e7c-9bbf-2bc1acedf331\"},{\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedClient\"]}],\"stateId\":\"ad706f63-47fa-4302-8156-b7a7d1dfcdf5\"},{\"conditions\":[{\"source\":\"context\",\"variable\":\"input.type\",\"comparison\":\"equals\",\"values\":[\"application/vnd.iris.ticket+json\"]},{\"source\":\"context\",\"variable\":\"input.content@status\",\"comparison\":\"equals\",\"values\":[\"ClosedClientInactivity\"]}],\"stateId\":\"96445234-1379-4a06-b1a5-704950cd2cb8\"},{\"conditions\":[{\"source\":\"context\",\"variable\":\"desk_forwardToDeskState_status\",\"comparison\":\"equals\",\"values\":[\"Error\"]}],\"stateId\":\"fallback\",\"typeOfStateId\":\"state\"},{\"stateId\":\"desk:668c6deb-1a44-43b4-ba93-9f2ec93e0e4d\"}]},{\"id\":\"c6851223-c62f-4e7c-9bbf-2bc1acedf331\",\"root\":false,\"name\":\"Closed by attendant\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"c6851223-c62f-4e7c-9bbf-2bc1acedf331\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Closed by attendant\"}}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"dealerDeskOrigin\",\"value\":\"Closed by attendant\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"typeOfStateId\":\"state\"}]},{\"id\":\"5c991c70-2844-4d70-b9a8-60fa9245d982\",\"root\":false,\"name\":\"Get default attendance hour id\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"5c991c70-2844-4d70-b9a8-60fa9245d982\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Get default attendance hour id\"}},{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"apiAttendanceHourStatus\",\"value\":\"blip timeout\"},\"conditions\":[]},{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"apiAttendanceHourResponse\"},\"conditions\":[]}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"ProcessHttp\",\"settings\":{\"headers\":{\"Authorization\":\"{{config.authorizationKey}}\"},\"method\":\"POST\",\"body\":\"{\\n    \\\"id\\\": \\\"{{random.guid}}\\\",\\n    \\\"method\\\": \\\"get\\\",\\n    \\\"to\\\": \\\"postmaster@desk.msging.net\\\",\\n    \\\"uri\\\": \\\"/attendance-hour\\\"\\n}\",\"uri\":\"{{commandsBaseUrl}}\",\"responseStatusVariable\":\"apiAttendanceHourStatus\",\"responseBodyVariable\":\"apiAttendanceHourResponse\"},\"conditions\":[]},{\"type\":\"ExecuteScript\",\"settings\":{\"function\":\"run\",\"source\":\"function run(apiAttendanceHourResponse) {\\n\\ttry\\n\\t{\\n\\t\\tconst serviceHours = JSON.parse(apiAttendanceHourResponse).resource.items;\\n\\n\\t\\tconst { id } =  serviceHours.find(sv => sv.isMain);\\n\\n\\t\\treturn id ? id : 'Default service hour does not exist'; \\n\\t}\\n\\tcatch(e)\\n\\t{\\n\\t\\treturn `[Error]: ${e.message}`\\n\\t}\\n}\",\"inputVariables\":[\"apiAttendanceHourResponse\"],\"outputVariable\":\"defaultAttendanceId\",\"LocalTimeZoneEnabled\":false},\"conditions\":[{\"values\":[\"200\"],\"source\":\"context\",\"comparison\":\"equals\",\"variable\":\"apiAttendanceHourStatus\"}]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"75bfc6fe-d7da-4010-ac99-91874608cb80\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"context\",\"comparison\":\"equals\",\"values\":[\"200\"],\"variable\":\"apiAttendanceHourStatus\"}]},{\"stateId\":\"818aacef-2d7a-4e3a-8514-c9fcbd7febd3\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"exists\",\"values\":[]}]},{\"stateId\":\"818aacef-2d7a-4e3a-8514-c9fcbd7febd3\",\"typeOfStateId\":\"state\"}]},{\"id\":\"818aacef-2d7a-4e3a-8514-c9fcbd7febd3\",\"root\":false,\"name\":\"Attendance hour API error\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"818aacef-2d7a-4e3a-8514-c9fcbd7febd3\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Attendance hour API error\"}}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"dealerDeskOrigin\",\"value\":\"Attendance hour API error\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"typeOfStateId\":\"state\"}]},{\"id\":\"75bfc6fe-d7da-4010-ac99-91874608cb80\",\"root\":false,\"name\":\"Get queue attendance hour id\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"75bfc6fe-d7da-4010-ac99-91874608cb80\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Get queue attendance hour id\"}},{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"apiQueuesStatus\",\"value\":\"blip timeout\"},\"conditions\":[]},{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"apiQueuesResponse\"},\"conditions\":[]}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"ProcessHttp\",\"settings\":{\"headers\":{\"Authorization\":\"{{config.authorizationKey}}\"},\"method\":\"POST\",\"body\":\"{\\n    \\\"id\\\": \\\"{{random.guid}}\\\",\\n    \\\"method\\\": \\\"get\\\",\\n    \\\"to\\\": \\\"postmaster@desk.msging.net\\\",\\n    \\\"uri\\\": \\\"/attendance-queues\\\"\\n}\",\"uri\":\"{{commandsBaseUrl}}\",\"responseStatusVariable\":\"apiQueuesStatus\",\"responseBodyVariable\":\"apiQueuesResponse\"},\"conditions\":[]},{\"type\":\"ExecuteScript\",\"settings\":{\"function\":\"run\",\"source\":\"function run(apiQueuesResponse, defaultAttendanceId, dealer) {\\n\\ttry\\n\\t{\\n\\t\\tconst  { name } = JSON.parse(dealer);\\n\\t\\tconst queues = JSON.parse(apiQueuesResponse).resource.items;\\n\\n\\t\\tfor (let i = 0; i < queues.length; i++)\\n\\t\\t{\\n\\t\\t\\tif (queues[i].name === name)\\n\\t\\t\\t\\treturn queues[i].attendanceHourId ? queues[i].attendanceHourId : defaultAttendanceId \\n\\t\\t}\\n\\n\\t\\treturn defaultAttendanceId\\n\\t}\\n\\tcatch(e)\\n\\t{\\n\\t\\treturn defaultAttendanceId\\n\\t}\\n}\",\"inputVariables\":[\"apiQueuesResponse\",\"defaultAttendanceId\",\"dealer\"],\"outputVariable\":\"attendanceHourId\",\"LocalTimeZoneEnabled\":false},\"conditions\":[{\"values\":[\"200\"],\"source\":\"context\",\"comparison\":\"equals\",\"variable\":\"apiQueuesStatus\"}]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5838c4af-b7c4-4100-97e3-fd0a923c185a\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"context\",\"comparison\":\"equals\",\"values\":[\"200\"],\"variable\":\"apiQueuesStatus\"}]},{\"stateId\":\"36722616-058e-4dec-bf09-8a808dfd29c3\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"exists\",\"values\":[],\"variable\":\"apiQueuesStatus\"}]},{\"stateId\":\"36722616-058e-4dec-bf09-8a808dfd29c3\",\"typeOfStateId\":\"state\"}]},{\"id\":\"36722616-058e-4dec-bf09-8a808dfd29c3\",\"root\":false,\"name\":\"Attendance hour id API error\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"36722616-058e-4dec-bf09-8a808dfd29c3\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Attendance hour id API error\"}}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"dealerDeskOrigin\",\"value\":\"Attendance hour id API error\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"typeOfStateId\":\"state\"}]},{\"id\":\"5838c4af-b7c4-4100-97e3-fd0a923c185a\",\"root\":false,\"name\":\"Get queue service hours\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"5838c4af-b7c4-4100-97e3-fd0a923c185a\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Get queue service hours\"}},{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"apiServiceHourStatus\",\"value\":\"blip timeout\"},\"conditions\":[]},{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"apiServiceHourResponse\"},\"conditions\":[]}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"ProcessHttp\",\"settings\":{\"headers\":{\"Authorization\":\"{{config.authorizationKey}}\"},\"method\":\"POST\",\"body\":\"{\\n    \\\"id\\\": \\\"{{random.guid}}\\\",\\n    \\\"method\\\": \\\"get\\\",\\n    \\\"to\\\": \\\"postmaster@desk.msging.net\\\",\\n    \\\"uri\\\": \\\"/attendance-hour-container/{{attendanceHourId}}\\\"\\n}\",\"uri\":\"{{commandsBaseUrl}}\",\"responseStatusVariable\":\"apiServiceHourStatus\",\"responseBodyVariable\":\"apiServiceHourResponse\"},\"conditions\":[]},{\"type\":\"ExecuteScript\",\"settings\":{\"function\":\"run\",\"source\":\"const run = (apiServiceHourResponse) => {\\n    const HOLIDAYS = JSON.parse(apiServiceHourResponse).resource.attendanceHourOffItems;\\n    \\n    let today = new Date();\\n    let holidayStart;\\n    let holidayEnd;\\n\\t\\t\\n    for (let i = 0; i < HOLIDAYS.length; i++) {\\n        holidayStart = new Date(HOLIDAYS[i].startDate);\\n        holidayEnd = new Date(HOLIDAYS[i].endDate);\\n\\n        if (today > holidayStart && today < holidayEnd)\\n            return \\\"Sim\\\";\\n    }\\n    \\n    return \\\"Nao\\\";\\n}\",\"inputVariables\":[\"apiServiceHourResponse\"],\"outputVariable\":\"isHoliday\",\"LocalTimeZoneEnabled\":false},\"conditions\":[{\"values\":[\"200\"],\"source\":\"context\",\"comparison\":\"equals\",\"variable\":\"apiServiceHourStatus\"}]},{\"type\":\"ExecuteScript\",\"settings\":{\"function\":\"run\",\"source\":\"const run = (apiServiceHourResponse, isHoliday) => {\\n    let dayOfWeek = processDayOfWeek();\\n    let todaysSchedule = getTodaysSchedule(apiServiceHourResponse, dayOfWeek);\\n\\n    // Se for feriado, então retornamos 'Nao' pois não está em horário de atendimento.\\n    if (isHoliday ===  \\\"Sim\\\")\\n        return \\\"Nao\\\";\\n\\n    return isWorkingHours(todaysSchedule);\\n}\\n\\nconst isWorkingHours = (schedule) => {\\n    let currentDateTime = new Date();\\n    let startTime;\\n    let endTime;\\n\\n    for (let i = 0; i < schedule.length; i++) {\\n        startTime = setDateTime(schedule[i].startTime);\\n        endTime = setDateTime(schedule[i].endTime);\\n\\n        if (currentDateTime > startTime && currentDateTime < endTime)\\n            return \\\"Sim\\\";\\n    }\\n\\n    return \\\"Nao\\\";\\n}\\n\\nconst setDateTime = (time) => {\\n    let resource = time.split(\\\":\\\");\\n    let dateTime = new Date();\\n\\n    dateTime.setHours(resource[0]);\\n    dateTime.setMinutes(resource[1]);\\n    dateTime.setSeconds(resource[2]);\\n    return dateTime;\\n}\\n\\nconst getTodaysSchedule = (response, dayOfWeek) => {\\n    let resource = JSON.parse(response).resource.attendanceHourScheduleItems;\\n    let schedule = resource.filter(item => item.dayOfWeek == dayOfWeek)\\n    return schedule;\\n}\\n\\nconst processDayOfWeek = () => {\\n    const DAYS_OF_WEEK = {\\n        0: \\\"Sunday\\\",\\n        1: \\\"Monday\\\",\\n        2: \\\"Tuesday\\\",\\n        3: \\\"Wednesday\\\",\\n        4: \\\"Thursday\\\",\\n        5: \\\"Friday\\\",\\n        6: \\\"Saturday\\\"\\n    }\\n\\n    let today = new Date().getDay();\\n    return DAYS_OF_WEEK[today];\\n}\",\"inputVariables\":[\"apiServiceHourResponse\",\"isHoliday\"],\"outputVariable\":\"isWorkingTime\",\"LocalTimeZoneEnabled\":false},\"conditions\":[{\"values\":[\"200\"],\"source\":\"context\",\"comparison\":\"equals\",\"variable\":\"apiServiceHourStatus\"}]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"52e0e59d-ddf3-473d-9177-b6b08b560184\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"context\",\"comparison\":\"equals\",\"values\":[\"200\"],\"variable\":\"apiServiceHourStatus\"}]},{\"stateId\":\"921f5310-cc33-4266-b3ca-88b5d9c784ec\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"exists\",\"values\":[]}]},{\"stateId\":\"921f5310-cc33-4266-b3ca-88b5d9c784ec\",\"typeOfStateId\":\"state\"}]},{\"id\":\"921f5310-cc33-4266-b3ca-88b5d9c784ec\",\"root\":false,\"name\":\"Service hours API error\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"921f5310-cc33-4266-b3ca-88b5d9c784ec\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Service hours API error\"}}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"dealerDeskOrigin\",\"value\":\"Service hours API error\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"typeOfStateId\":\"state\"}]},{\"id\":\"52e0e59d-ddf3-473d-9177-b6b08b560184\",\"root\":false,\"name\":\"Is Working time?\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"52e0e59d-ddf3-473d-9177-b6b08b560184\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Is Working time?\"}}],\"input\":{\"bypass\":true},\"outputActions\":[],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"76775935-451d-496c-9a13-14b5ba85bafd\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"context\",\"comparison\":\"equals\",\"values\":[\"Nao\"],\"variable\":\"isWorkingTime\"}]},{\"stateId\":\"cc789374-db17-4a28-8e53-9f2276f6703d\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"context\",\"comparison\":\"equals\",\"values\":[\"Sim\"],\"variable\":\"isWorkingTime\"}]},{\"stateId\":\"fallback\"}]},{\"id\":\"76775935-451d-496c-9a13-14b5ba85bafd\",\"root\":false,\"name\":\"Is Holiday?\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"76775935-451d-496c-9a13-14b5ba85bafd\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Is Holiday?\"}}],\"input\":{\"bypass\":true},\"outputActions\":[],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5816fb10-1eda-40e3-9c4f-33f2157ffbb0\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"context\",\"comparison\":\"equals\",\"values\":[\"Nao\"],\"variable\":\"isHoliday\"}]},{\"stateId\":\"f117f44b-e4df-4afe-b7d9-3f2e3247b23d\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"context\",\"comparison\":\"equals\",\"values\":[\"Sim\"],\"variable\":\"isHoliday\"}]},{\"stateId\":\"fallback\"}]},{\"id\":\"5816fb10-1eda-40e3-9c4f-33f2157ffbb0\",\"root\":false,\"name\":\"Out of service hour\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"5816fb10-1eda-40e3-9c4f-33f2157ffbb0\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Out of service hour\"}}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"dealerDeskOrigin\",\"value\":\"Out of service hour\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"typeOfStateId\":\"state\"}]},{\"id\":\"f117f44b-e4df-4afe-b7d9-3f2e3247b23d\",\"root\":false,\"name\":\"Holiday\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"f117f44b-e4df-4afe-b7d9-3f2e3247b23d\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Holiday\"}}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"dealerDeskOrigin\",\"value\":\"Holiday\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"typeOfStateId\":\"state\"}]},{\"id\":\"96445234-1379-4a06-b1a5-704950cd2cb8\",\"root\":false,\"name\":\"Closed by inactivity\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"96445234-1379-4a06-b1a5-704950cd2cb8\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Closed by inactivity\"}}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"dealerDeskOrigin\",\"value\":\"Closed by inactivity\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"typeOfStateId\":\"state\"}]},{\"id\":\"ad706f63-47fa-4302-8156-b7a7d1dfcdf5\",\"root\":false,\"name\":\"Closed by client\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"ad706f63-47fa-4302-8156-b7a7d1dfcdf5\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Closed by client\"}}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"dealerDeskOrigin\",\"value\":\"Closed by client\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"typeOfStateId\":\"state\"}]},{\"id\":\"c0eaa7f1-01e2-4436-9c9d-0e04f14d2d9e\",\"root\":false,\"name\":\"Offline Attendants\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"c0eaa7f1-01e2-4436-9c9d-0e04f14d2d9e\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Offline Attendants\"}}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"SetVariable\",\"settings\":{\"variable\":\"dealerDeskOrigin\",\"value\":\"Offline Attendants\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"typeOfStateId\":\"state\"}]},{\"id\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"root\":false,\"name\":\"Redirect to Dealers Desk Exit\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"5fbe5fa1-1292-4fea-bea3-83677f932348\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"Redirect to Dealers Desk Exit\"}},{\"type\":\"ExecuteScript\",\"settings\":{\"function\":\"run\",\"source\":\"const  response = {\\n\\torigin: '{{application.identifier}}',\\n\\tbotId: '{{application.identifier}}',\\n\\tcontext: null,\\n\\terror: null,\\n\\tticket: null\\n}\\n\\nconst POST_DESK_ORIGINS = [ \\n\\t'Closed by attendant', \\n\\t'Closed by client', \\n\\t'Closed by inactivity' \\n];\\n\\nfunction run(inputContent, dealerDeskOrigin, dealer) {\\n\\ttry {\\n\\t\\tconst { group } = JSON.parse(dealer);\\n\\n\\t\\tif (POST_DESK_ORIGINS.includes(dealerDeskOrigin)) {\\n\\t\\t\\tresponse.ticket = JSON.parse(inputContent)\\n\\t\\t}\\n\\n\\t\\tresponse.context = dealerDeskOrigin\\n\\t\\tresponse.origin = group\\n\\n\\t\\treturn response;\\n\\t}\\n\\tcatch(e) {\\n\\t\\tresponse.error =  e.message;\\n\\t\\treturn response;\\n\\t}\\n}\",\"inputVariables\":[\"input.content\",\"dealerDeskOrigin\",\"dealer\"],\"outputVariable\":\"message\",\"LocalTimeZoneEnabled\":false},\"conditions\":[]}],\"input\":{\"bypass\":true},\"outputActions\":[{\"type\":\"Redirect\",\"settings\":{\"context\":{\"type\":\"text/plain\",\"value\":\"{{message}}\"},\"address\":\"dealersdeskexit\"},\"conditions\":[]}],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"onboarding\",\"typeOfStateId\":\"state\"}]},{\"id\":\"cc789374-db17-4a28-8e53-9f2276f6703d\",\"root\":false,\"name\":\"T.1.0.2 Pre desk message\",\"inputActions\":[{\"type\":\"TrackContactsJourney\",\"settings\":{\"previousStateId\":\"{{state.previous.id}}\",\"previousStateName\":\"{{state.previous.name}}\",\"stateId\":\"{{state.id}}\",\"stateName\":\"{{state.name}}\"}},{\"type\":\"TrackEvent\",\"settings\":{\"extras\":{\"stateId\":\"cc789374-db17-4a28-8e53-9f2276f6703d\",\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"},\"category\":\"flow\",\"action\":\"T.1.0.2 Pre desk message\"}},{\"type\":\"SendMessage\",\"settings\":{\"id\":\"87b4c8ca-7b1d-458f-8345-93121b7e210e\",\"type\":\"application/vnd.lime.chatstate+json\",\"content\":{\"state\":\"composing\",\"interval\":1000},\"metadata\":{\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"}}},{\"type\":\"SendMessage\",\"settings\":{\"id\":\"278e0c71-339e-41d2-8c23-0387f7971e6f\",\"type\":\"text/plain\",\"content\":\"{{preDeskMessage}}\",\"metadata\":{\"#stateName\":\"{{state.name}}\",\"#stateId\":\"{{state.id}}\",\"#messageId\":\"{{input.message@id}}\",\"#previousStateId\":\"{{state.previous.id}}\",\"#previousStateName\":\"{{state.previous.name}}\"}}}],\"input\":{\"bypass\":true},\"outputActions\":[],\"afterStateChangedActions\":[],\"outputs\":[{\"stateId\":\"desk:668c6deb-1a44-43b4-ba93-9f2ec93e0e4d\",\"typeOfStateId\":\"state\",\"conditions\":[{\"source\":\"input\",\"comparison\":\"exists\",\"values\":[]}]},{\"stateId\":\"desk:668c6deb-1a44-43b4-ba93-9f2ec93e0e4d\",\"typeOfStateId\":\"state\"}]}],\"configuration\":{\"builder:minimumIntentScore\":\"0.5\",\"builder:stateTrack\":\"true\",\"builder:useTunnelOwnerContext\":\"true\",\"builder:#localTimeZone\":\"E. South America Standard Time\",\"authorizationKey\":\"<AUTHORIZATIONKEY>\",\"gmt\":\"-3\"},\"inputActions\":[],\"outputActions\":[],\"type\":\"flow\"}},\"settingsType\":\"Settings\"}"
        };

        request.SetBearerToken(token);

        await flowFacade.PublishFlowAsync(request, flow.OpenReadStream());

        return Ok();
    }
}